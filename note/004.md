# Middleware

server.jsë¥¼ ì•„ë˜ì™€ ê°™ì´ ë‹¤ì‹œ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```javascript
import express from "express";

const app = express();
const PORT = 4000;

const handleHome = (req, res) => res.send("SERVER!!!");

app.get("/", handleHome);

const handleListen = () => console.log(`ğŸ¸ Server listening on PORT ${PORT}`);

app.listen(PORT, handleListen);
```

app.get í•¨ìˆ˜ì— handleHome ì´ë¼ëŠ” ì½œë°±í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì˜€ë‹¤.

ì—¬ê¸°ì„œ handleHome í•¨ìˆ˜ê°€ Middlewareê°€ ëœë‹¤.

---

<br>

## Middleware í•¨ìˆ˜ëŠ” request-response cycleì—ì„œ `req`, `res`ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì œê³µí•œë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ì–´ë–¤ ì‚¬ìš©ìê°€ ì„œë²„ì— ë¡œê·¸ì¸ì„ í•˜ë©´ í•´ë‹¹ ìœ ì €ì— ëŒ€í•œ ì •ë³´ê°€ `res.user`ì— ì €ì¥ë  ìˆ˜ ìˆë‹¤.

handleHome í•¨ìˆ˜ëŠ” `req`, `res` ë¼ëŠ” **Express Standard Parameter** ë¥¼ ë„˜ê²¨ ë°›ëŠ”ë‹¤. ì´ëŠ” expressì—ì„œ ì§ì ‘ ë„˜ê²¨ì£¼ëŠ” **object**ì´ë‹¤.

`req`ëŠ” í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„°ì˜ ìš”ì²­ì„ ì˜ë¯¸í•œë‹¤(request). ë¼ìš°í„° í•¸ë“¤ëŸ¬ í•¨ìˆ˜ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

`res`ëŠ” ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì— ëŒ€ì‘í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤ (response). ë¼ìš°í„° í•¸ë“¤ëŸ¬ í•¨ìˆ˜ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°(ì¼ë°˜ì ìœ¼ë¡œ json format)ë¥¼ ë³´ë‚¼ ë•Œ ì‚¬ìš©í•œë‹¤.

ì‚¬ì‹¤ íŒŒë¼ë¯¸í„°ê°€ í•˜ë‚˜ ë” ìˆë‹¤.

```javascript
const handleHome = (req, res, next) => res.send("SERVER!!!");
```

ìœ„ ì½”ë“œë¥¼ ë³´ë©´ `next` íŒŒë¼ë¯¸í„°ê°€ ì¶”ê°€ë˜ì—ˆë‹¤. ì´ëŠ” ë‹¤ë¥¸ **Middleware**ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤.

ì´ë ‡ê²Œ ì—¬ëŸ¬ ê°œì˜ **Middleware** ë“¤ì´ ì—°ì‡„ì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ê²ƒì„ `middleware chain`ì´ë¼ í•œë‹¤. ì´ ì²´ì¸ì˜ ë§ˆì§€ë§‰ í•¨ìˆ˜ëŠ” ê¼­ responseë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬í•´ì•¼ í•œë‹¤. `req`, `res`ì˜ ë³€ê²½ ì‚¬í•­ì€ ê·¸ ë‹¤ìŒ middleware í˜¸ì¶œì—ì„œë„ ë°˜ì˜ì´ ëœë‹¤. ë˜í•œ `req`, `res` objectì€ ê°ê°ì˜ ìš”ì²­ë§ˆë‹¤ ë…ë¦½ì ì´ë‹¤.

> ë§Œì•½ middleware chainì˜ ë§ˆì§€ë§‰ í•¨ìˆ˜ê°€ ì•„ë‹Œ í•¨ìˆ˜ì—ì„œ next()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ë¦¬í€˜ìŠ¤íŠ¸ ì²˜ë¦¬ê°€ ë©ˆì¶”ê³  ê²°êµ­ì—” timeoutì´ ëœ¬ë‹¤.

---

<br>

## app.use()

app.get() í•¨ìˆ˜ ì™¸ì—ë„ app.use() í•¨ìˆ˜ê°€ ìˆë‹¤. ì´ëŠ” **middleware**ë¥¼ í•´ë‹¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ë°”ì¸ë”©í•˜ê¸° ìœ„í•œ í•¨ìˆ˜ì´ë‹¤.

```javascript
// index.js
import express from "express";

const app = express();
const PORT = 4000;

const handleHome = (req, res) => {
  console.log("handleHome!!");
  return res.send("SERVER!!!");
};
const firstMiddleware = (req, res, next) => {
  console.log("It's the first middleware!!");
  next();
};
const secondMiddleware = (req, res, next) => {
  console.log("It's the second middleware!!");
  next();
};

app.use("/", firstMiddleware);
app.use("/", secondMiddleware);
app.get("/", handleHome);

const handleListen = () => console.log(`ğŸ¸ Server listening on PORT ${PORT}`);

app.listen(PORT, handleListen);
```

ìœ„ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤.

<img src="./img/004_middleware.png">

app.use() í•¨ìˆ˜ë¡œ firstMiddlewareì™€ secondMiddlewareë¥¼ ë°”ì¸ë”© í•˜ì˜€ê³  **next() í•¨ìˆ˜ë¥¼ í˜¸ì¶œ** í•˜ì—¬ ë‹¤ìŒ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ë‹¤ìŒ middlewareë¡œ ë„˜ì–´ê°€ê²Œ í•´ì£¼ì—ˆë‹¤. ë§Œì•½ next() í˜¸ì¶œì„ í•˜ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì € ìŠ¤í”¼ë„ˆê°€ ê³„ì† ëŒê²Œ ëœë‹¤.

**app.use() í•¨ìˆ˜ëŠ” ì½”ë“œ ìƒì—ì„œ ì–¸ì œë‚˜ app.get() í•¨ìˆ˜ ìœ„ì— ìˆì–´ì•¼ í•œë‹¤!!!**

<br>

## Return Response Object

response objectì„ ë°˜í™˜í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆë‹¤.

- `res.end()`: ë°ì´í„° ì „ì†¡ ì—†ì´ responseë¥¼ ëë‚¸ë‹¤.
- `res.send([body])`: HTTP responseë¥¼ ë°˜í™˜í•œë‹¤. í•˜ë‚˜ì˜ íŒŒë¼ë¯¸í„°ë§Œ í—ˆìš©ë˜ë©° íŒŒë¼ë¯¸í„°ëŠ” Buffer object, ìŠ¤íŠ¸ë§, object, ë°°ì—´ ë“±ì´ ê°€ëŠ¥í•˜ë‹¤. res.send()ëŠ” res.end()ë¥¼ í¬í•¨í•œë‹¤.
- `res.redirect([status, ] path)`: HTTP status codeì™€ ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ê²½ë¡œë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ê°€ì§ˆ ìˆ˜ ìˆë‹¤. res.end()ë¥¼ í¬í•¨í•œë‹¤.
- `res.render(view, [, locals] [, callback])`: viewë¥¼ ë Œë”í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ë©° ë Œë”ë§ëœ HTML stringì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜í•œë‹¤. ë‘ ê°€ì§€ íŒŒë¼ë¯¸í„°ê°€ í—ˆìš©ë˜ë©° localsëŠ” viewë¥¼ ìœ„í•œ local property(.ejs, .pug etc.)ë¥¼ ì˜ë¯¸í•œë‹¤. ë‹¤ë¥¸ í•˜ë‚˜ëŠ” callback í•¨ìˆ˜ì´ë‹¤.

**í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì€ í•œ ë²ˆë§Œ í•´ì•¼í•œë‹¤!!**

---

<br>

[ìµœì¢… ì½”ë“œ ê¹ƒí—™ ë§í¬](https://github.com/empodi/wetube-2022/commit/103c61574bb4deeb4165d66ac23dbf2b5b9a92de)

<br>

ì°¸ê³  ë§í¬  
[Link](https://medium.com/@jamischarles/what-is-middleware-a-simple-explanation-bb22d6b41d01)  
[Link](https://stackoverflow.com/questions/31928417/chaining-multiple-pieces-of-middleware-for-specific-route-in-expressjs)  
[Link](https://discuss.codecademy.com/t/whats-the-significance-of-the-req-res-next-callback/565775)  
[Link](https://stackoverflow.com/questions/29555290/what-is-the-difference-between-res-end-and-res-send)  
[Link](https://www.geeksforgeeks.org/difference-between-app-use-and-app-get-in-express-js/)  
[Link](https://www.geeksforgeeks.org/express-js-res-send-function/)  
[Link](https://www.geeksforgeeks.org/express-js-res-render-function/?ref=lbp)
